<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.7.0/d3.min.js" integrity="sha512-cd6CHE+XWDQ33ElJqsi0MdNte3S+bQY819f7p3NUHgwQQLXSKjE4cPZTeGNI+vaxZynk1wVU3hoHmow3m089wA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
    <svg id="bubble-chart"></svg>
    <style>
      .wrapper, circle, .course {
        cursor: pointer;
        pointer-events: all;
      }
      .selected {
        fill: green;
      }
      .available {
        fill: yellow;
      }
      .available:hover {
        fill: yellowgreen;
      }
      .unavailable {
        fill: lightgrey;
      }
      .unavailable:hover {
        fill: lightgreen;
      }
    </style>
    <script>
      let courseDataURL = 'https://raw.githubusercontent.com/liamrathke/final/main/data/data.json'

      let nodes = {}

      let selected = []
      let available = [0]

      const styles = {
        selected: {
          color: 'green'
        },
        available: {
          color: 'yellow'
        },
        unavailable: {
          color: 'lightgrey'
        },
        hover: {
          color: 'lightgreen'
        }
      }

      const sizes = {
        1: 100,
        2: 90,
        3: 80,
        4: 70
      }

      const width = window.innerWidth
      const height = window.innerHeight

      function generateChart(nodes) {
        // generate the chart!
        console.log(nodes)

        function bubble(data) {
          return d3.pack()
            .size([width, height])
            .padding(2)(d3.hierarchy({ children: data }).sum(d => sizes[d.level]))
        }

        const svg = d3.select('#bubble-chart')
          .style('width', width)
          .style('height', height)

        const root = bubble(nodes)

        const node = svg.selectAll()
          .data(root.children)
          .enter().append('g')
          .attr('class', 'wrapper')
          .attr('transform', `translate(${width / 2}, ${height / 2})`)
        
        const circle = node.append('circle')
          .attr('class', d => {
            if (selected.includes(d.data.id)) {
              return 'course selected'
            } else if (available.includes(d.data.id)) {
              return 'course available'
            } else {
              return 'course unavailable'
            }
          })
          .on('mousemove', e => {
            console.log(e)
          })
          .on('mouseout', () => {
            console.log('mouseout')
          })
          .on('mouseover', (e, d) => {
            console.log(e, d)
          })

        const course = node.append('g')
          .attr('transform', d => `translate(${-d.r}, ${-d.r})`)
          .style('z-index', 999)
          .style('pointer-events', 'none')

        const obj = course.append('foreignObject')
          .attr('width', d => 2 * d.r)
          .attr('height', d => 2 * d.r)
          .append('xhtml:div')
          .style('display', 'flex')
          .style('align-items', 'center')
          .style('justify-content', 'center')
          .style('height', '100%')
          .append('xhtml:div')
          .style('width', 'auto')
          .style('text-align', 'center')

        // const div = obj.append('div')
        //   .style('display', 'flex')
        //   .style('align-items', 'center')
        //   .style('justify-content', 'center')

        const number = obj.append('p')
          .text(d => d.data.number)

        const name = obj.append('p')
          .text(d => d.data.name)
        
        // const label = course.append('text')
        //   .text(d => d.data.name.substring(0, d.r / 3))

        node.transition()
          .ease(d3.easeExpInOut)
          .duration(1000)
          .attr('transform', d => `translate(${d.x}, ${d.y})`)

        circle.transition()
          .ease(d3.easeExpInOut)
          .duration(1000)
          .attr('r', d => d.r)

        course.transition()
          .ease(d3.easeExpInOut)
          .duration(1000)
      }

      (async () => {
          data = await d3.json(courseDataURL).then(data => data)
          nodes = data.nodes
          generateChart(nodes)
      })()
    </script>
  </body>
</html>